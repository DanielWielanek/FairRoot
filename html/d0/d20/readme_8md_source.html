<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>FairRoot: /tmp/turany/FairRoot/alignment/readme.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">FairRoot
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d0/d20/readme_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/tmp/turany/FairRoot/alignment/readme.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d0/d20/readme_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor"># Alignment Module in FairRoot</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;This is the alignment <span class="keyword">interface </span>module in FairRoot. It&#39;s supposed to handle the misalignment of individual detector components and give the user a simple interface to create misalignment matrices and apply them to the current working geometry in a simulation macro.</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;**Caveat Emptor**: Some of the functions <span class="keywordflow">do</span> not exist yet. For example, misalignment matrices must be created by your own scripts/macros. </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">## About Misalignment Matrices</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The difference between the design position of a detector component and its actual position after construction is called misalignment. It can be expressed as a 4x4 homogenous transformation matrix that describes the translation and rotation of the component from its ideal position to its actual position. If the component is exaclty where it<span class="stringliteral">&#39;s supposed to be, this matrix will be the 4x4 identity matrix. We don&#39;</span>t expect <span class="keyword">this</span> to happen though.</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;These transformation matrices are called *misalignment matrices*. The alignment module presented here uses these misalignment matrices and mutiplies them onto the current stack of position matrices of a component. Should a component be subject to misalignment *and* have <a class="code" href="../../d8/dcf/classsub.html">sub</a>-components, then these <a class="code" href="../../d8/dcf/classsub.html">sub</a>-components will be affected by the misalignment as well. This is a very intuitive way to model the detector misalignment as a whole. This is all done at simulation time or reconstruction time (see different methods of apllication), but the misaligned geometry will not be written to disk.</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Instead, we will always assume a perfect model of our geometry and apply the misalignment geometries as needed. These matrices should therefore be stored on disk <span class="keywordflow">for</span> reproducibility. This will enable you to generate data as you would obtain it with a misaligned (i.e. actual, pysical) detector **without correcting <a class="code" href="../../d4/d33/fill__parameters_8C.html#ab97a5a7979d4b275060bb0ce6ce91273">for</a> misalignment**.</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;These are <a class="code" href="../../d4/d33/fill__parameters_8C.html#ab97a5a7979d4b275060bb0ce6ce91273">for</a> example <a class="code" href="../../d4/d33/fill__parameters_8C.html#ab97a5a7979d4b275060bb0ce6ce91273">for</a> acceptance studies and to see how your measurement accuracy is reduced due to detector position uncertainty.</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">## Alignment Matrices</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;The reverse of <span class="keyword">this</span> is <span class="keyword">using</span> measurement data about the positions of your components that you <span class="keyword">get</span> from the survey crew (or your own surveys) and apply it to your measured data. Ideally, these are also transformation matrices, just like the misalignment matrices, and <span class="keywordflow">if</span> we could measure the position of actual detector components perfectly and without error, the alignment matrices are identical to the misalignment matrices. Their purpose is different however, which is why we make <span class="keyword">this</span> distinction.</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;Suppose you have already built the detector and measured data with it, and now want to <span class="keyword">remove</span> the misalignment from that data. You would then use the *alignment matrices* and give them to <span class="keyword">this</span> module which will apply them to the simulation to <span class="keyword">remove</span> the bias from misalignment. The reconstructed tracks or points you <span class="keyword">get</span> from <span class="keyword">this</span> reconstruction runs are just as you would <span class="keyword">get</span> them from a prefectly positioned detector (mis differences in acceptacnce etc).</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;These are <span class="keywordflow">for</span> real data and are only applicale to a real detector.</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;That means of course, <span class="keywordflow">if</span> you generate misalignment matrices at random, apply them to the monte carlo simulation as misalignment *and* also apply them to the reconstruction as alignment matrices, then you would <span class="keyword">get</span> the exact same data as with no misalignment whatsoever. <a class="code" href="../../d4/dc4/structA.html">A</a> more realistic scenario would probably be to use misalignment matrices and alignment matrices at the same time that aren<span class="stringliteral">&#39;t identical.</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="stringliteral"># Usage</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="stringliteral">This approach assumes one global, perfect version of the detector geometry that is changed during runtime of the simualtion steps, but never stored to disk. This ensures that there is always one known-good geometry, which we will call ideal geometry. The AlignmentHandler class changes the geometry that is currently loaded into the gGeoManager, so every following macro that uses the gGeoManager uses this changed geometry.</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="stringliteral">The user can choose wether to apply the misalignments to the geometry or the generated data.</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="stringliteral">Usually, the steps are</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="stringliteral">- produce misalignment matrices</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="stringliteral">- store them to disk</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="stringliteral">- apply them to current working geometry during simulation</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="stringliteral">- *or* apply them to reconstructed data during analysis</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="stringliteral">It is important that these misalignment matrices are applied *either* to the geometry *or* the reconstructed data, not both (We would not see any misalignment this way).</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="stringliteral">## Create Misalignment Matrices</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="stringliteral">The user can supply their own misalignment matrices, or have the module generate them. A misalignment matrices is always applied onto the current matrix in the current frame of reference of that detector element. For example, if the user were to apply an identity matrix to the current position matrix, it would not change the position of the element.</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="stringliteral">The module can not generate misalignment matrices yet, but see the example below on how to create them youself.</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="stringliteral">### Set Boundary Conditions</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="stringliteral">Not done yet. This will be specified in the script or macro that creates your misalignment matrices.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="stringliteral">## Store to and read from Disk</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="stringliteral">Not done yet. It is up to you how you write and read the matrices.</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="stringliteral">## Apply Misalignment to Geometry</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral">Applying to geometry means moving actual detector parts and running track finders etc. without knowledge of this misalignment. The reconstructed tracks are non-ideal, but the simulation resembles real geometry with real misalignments. **In the simulation, no precautions for clashing volumes are taken!** If two sensors intersect and are hit by a monte carlo track, it seems only one of the sensors registeres that mc track, but for now, we can&#39;</span>t give any gurantees.</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;Apart from intersecting objects, <span class="keyword">this</span> approach mimics physical geometry and detector acceptance. We call <span class="keyword">this</span> method <span class="stringliteral">&quot;misalign geometry&quot;</span> to set it apart from the other method.</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;## Apply Misalignment to Reconstructed Data</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;Applying to data is the other approach, where we don<span class="stringliteral">&#39;t touch the geometry but instead transform the reconstructed hits. This means that we load and use the misalignment matrices while running the reconstruction macros. This way, no two sensors can intersect. This approach might produce implausible tracks however, since we change the acceptance by transforming the reconstructed data. We sometimes call this method &quot;misalign data&quot; to set it apart from the other method.</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="stringliteral">It is well suited if you can&#39;</span>t regenerate monte carlo data <span class="keywordflow">for</span> every misaligned scenario you wish to explore, since reconstruction runs are usually faster than generation-and-reconstruction runs.</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;# Examples</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">## Create a Set of Matrices with Random Rotation around the z Axis and shift in x and y Directions</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;For now, the misalignment matrices and alignment matrices are stored in a `std::map&lt;std::string, TGeoHMatrix&gt;`. The `std::string` is the path of the component and the TGeoHMatrix is the misalginment or alignment matrix.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;A simple example is to create a matrix that will rotate about the z axis and shift in the xy plane <span class="keywordflow">for</span> every sensor:</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;```cpp</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">// use Mersenne Twister</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seed = 128;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;TRandom3 *PRNG = <span class="keyword">new</span> TRandom3(seed);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;TGeoHMatrix createRandomMatrix(<span class="keywordtype">double</span> angleSigma, <span class="keywordtype">double</span> shiftSigma) {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">double</span> mean = 0;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">double</span> sigmaX, sigmaY, sigmaZ;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">double</span> shift[3];</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  sigmaX = 0;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  sigmaY = 0;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  sigmaZ = PRNG-&gt;Gaus(mean, angleSigma);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">// can&#39;t move in z</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  shift[0] = PRNG-&gt;Gaus(mean, shiftSigma);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  shift[1] = PRNG-&gt;Gaus(mean, shiftSigma);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  shift[2] = 0;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  TGeoHMatrix result;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  result.RotateZ(sigmaZ);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  result.SetTranslation(shift);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;}</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordtype">int</span> createPndLmdMisalignmentMatrices() {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="comment">// get all component paths</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    std::vector&lt;std::string&gt; paths = getGeometryPaths();    <span class="comment">// you have to get the paths somehow</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    std::map&lt;std::string, TGeoHMatrix&gt; matrices;            <span class="comment">// you give this to fRun</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">// create matrices and save to map</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;i : paths) {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        matrices[i] = createRandomMatrix(rot, shift);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="comment">// save matrices to disk</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    TFile *misalignmentMatrixRootfile = <span class="keyword">new</span> TFile(<span class="stringliteral">&quot;matrices.root&quot;</span>, <span class="stringliteral">&quot;NEW&quot;</span>);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keywordflow">if</span> (misalignmentMatrixRootfile-&gt;IsOpen()) {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    gDirectory-&gt;WriteObject(&amp;matrices, <span class="stringliteral">&quot;PndLmdMisalignMatrices&quot;</span>);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    misalignmentMatrixRootfile-&gt;Write();</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    misalignmentMatrixRootfile-&gt;Close();</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    }</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;```</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor">## Misalign Geometry at Simulation Time</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;This must be added to your Simulation macro (boxsim, dpm etc.)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;```cpp</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<a class="code" href="../../de/da9/classFairRunAna.html">FairRunAna</a> *fRun = <span class="keyword">new</span> <a class="code" href="../../de/da9/classFairRunAna.html">FairRunAna</a>();</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;std::map&lt;std::string, TGeoHMatrix&gt; misalign_matrices = getMatrices(<span class="stringliteral">&quot;/path/on/disk&quot;</span>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;fRun-&gt;AddAlignmentMatrices(misalign_matrices);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">// [...] other code</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;fRun-&gt;Init();</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">// [...] other code</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;```</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="preprocessor">## Misalign Data at Reconstruction Time</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;This would be in your reconstruction macro.</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;```cpp</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<a class="code" href="../../de/da9/classFairRunAna.html">FairRunAna</a> *fRun = <span class="keyword">new</span> <a class="code" href="../../de/da9/classFairRunAna.html">FairRunAna</a>();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;std::map&lt;std::string, TGeoHMatrix&gt; misalign_matrices = getMatrices(<span class="stringliteral">&quot;/path/on/disk&quot;</span>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="keywordtype">bool</span> invert_matrices = <span class="keyword">true</span>;        <span class="comment">// if you use the misalignment drung the reco macros, they have to be inverted</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;fRun-&gt;AddAlignmentMatrices(misalign_matrices, invert_matrices);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;std::map&lt;std::string, TGeoHMatrix&gt; align_matrices = getOtherMatrices(<span class="stringliteral">&quot;/path/on/disk&quot;</span>);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;fRun-&gt;AddAlignmentMatrices(align_matrices, invert_matrices);    <span class="comment">// you can stack alignment matrices as well!</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">// [...] other code</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;fRun-&gt;Init();</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">// [...] other code</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;```</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">## Set physically measured Position Matrices to Geometry </span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;Eventually, we will want to set matrices to our geometry which were measured on the real detector. That can be by laser tracker, theodolite or any other means.</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;The <span class="keyword">interface </span>exists but is not tested yet.</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;# Known Issues</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;None as of yet, but some functionality is still missing.</div>
<div class="ttc" id="fill__parameters_8C_html_ab97a5a7979d4b275060bb0ce6ce91273"><div class="ttname"><a href="../../d4/d33/fill__parameters_8C.html#ab97a5a7979d4b275060bb0ce6ce91273">for</a></div><div class="ttdeci">for(Int_t i=0;i&lt; 100;i++)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d33/fill__parameters_8C_source.html#l00013">fill_parameters.C:13</a></div></div>
<div class="ttc" id="classFairRunAna_html"><div class="ttname"><a href="../../de/da9/classFairRunAna.html">FairRunAna</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d7c/FairRunAna_8h_source.html#l00033">FairRunAna.h:33</a></div></div>
<div class="ttc" id="classsub_html"><div class="ttname"><a href="../../d8/dcf/classsub.html">sub</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/d66/cxx11-test-class__override__final_8cpp_source.html#l00009">cxx11-test-class_override_final.cpp:9</a></div></div>
<div class="ttc" id="structA_html"><div class="ttname"><a href="../../d4/dc4/structA.html">A</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d6c/cxx11-test-funcptr-to-lambda-conversion_8cpp_source.html#l00005">cxx11-test-funcptr-to-lambda-conversion.cpp:5</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d20/readme_8md.html">readme.md</a></li>
    <li class="footer">Generated on Mon Mar 8 2021 12:14:05 for FairRoot by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
